---
title: "gimme-multiverse"
author: "Bj√∂rn Siepe"
date: "`r Sys.Date()`"
output: html_document
---

In this document, we perform multiverse analysis for two datasets.


# Preparation
Load all relevant packages:
```{r packages}
library(mvgimme)       # fork of gimmme package that allows multiverse
library(tidyverse)     # data handling
library(here)          # reproducible folder settings
library(tictoc)        # timing
library(RColorBrewer)  # color palette
source("scripts/aux_funs.R")
set.seed(35037)
```


# Load reference fits
We load the reference fits, i.e. results of GIMME as reported in the literature. 

```{r load-ref-fits}
ref_fit_pers_og <- readRDS(here("data/wright_2019/wright_2019_fit_nondetrend.RDS"))
ref_fit_emot_og <- readRDS(here("data/kullar_2023/kullar_2023_fit.RDS"))
```



# Fit multiverse

Multiverse parameters:
```{r multiverse-params}

group_cuts <- c(.50, .60, .75, .80)
sub_cuts <- c(.50, .60, .75, .80)
rmsea_cuts <- c(.03, .05, .08)
srmr_cuts <- c(.03, .05, .08)
nnfi_cuts <- c(.90, .95, .97)
cfi_cuts <- c(.90, .95, .97)
n_excels <- c(1, 2, 3)

multiverse_grid <- expand.grid(
  group_cuts = group_cuts,
  sub_cuts = sub_cuts,
  rmsea_cuts = rmsea_cuts,
  srmr_cuts = srmr_cuts,
  nnfi_cuts = nnfi_cuts,
  cfi_cuts = cfi_cuts,
  n_excels = n_excels
)

```




## Personality Dataset
```{r multiverse-personality}
# for testing
data_list <- readRDS(here("data/wright_2019/data_list.RDS"))
tic()
mv_res_pers <- mvgimme::multiverse.gimme(data = here("data/wright_2019/individual_files"),
                                         sep = ",",
                                         header = TRUE,
                                         subgroup = TRUE,
                                         ar = TRUE,
                          groupcutoffs = group_cuts, 
                          subcutoffs = sub_cuts,
                          rmsea.cuts = rmsea_cuts,
                          srmr.cuts = srmr_cuts,
                          nnfi.cuts = nnfi_cuts,
                          cfi.cuts = cfi_cuts,
                          n.excellent = n_excels,
                          n.cores = 60,
                          prune_output = TRUE,
                          save_output = TRUE)
toc()

saveRDS(mv_res_pers, file = here("output/mv_personality/mv_res_pers.RDS"))
mv_res_pers <- readRDS(here("output/mv_personality/mv_res_pers2.RDS"))

```





## Emotion Dataset

```{r multiverse-personality}
mv_res_emot <- mvgimme::multiverse.gimme(data = here("data/kullar_2023/finaloutput"),
                                         header = TRUE,
                                         sep = ",",
                                         subgroup = TRUE,
                                         ar = TRUE,
                          groupcutoffs = group_cuts, 
                          subcutoffs = sub_cuts,
                          rmsea.cuts = rmsea_cuts,
                          srmr.cuts = srmr_cuts,
                          nnfi.cuts = nnfi_cuts,
                          cfi.cuts = cfi_cuts,
                          n.excellent = n_excels,
                          n.cores = 60,
                          prune_output = TRUE,
                          save_output = TRUE, 
                          exogenous = "TimeofDay",
                          save_dir = here("output/mv_emotion"))


# 248908.521 sec
# saveRDS(mv_res_emot, file = here("output/mv_emotion/mv_res_emot_new.RDS"))
mv_res_emot <- readRDS(here("output/mv_emotion/mv_res_emot_new.RDS"))


```


# Analyze multiverse

## Personality Dataset
Delete reference fit from multiverse dataset.
```{r}
ref_fit_ind <- multiverse_grid %>% 
  mutate(spec = dplyr::row_number()) %>% 
  filter(group_cuts == .75 &
                        sub_cuts == .50 &
                        rmsea_cuts == .05 &
                        srmr_cuts == .05 &
                        nnfi_cuts == .95 &
                        cfi_cuts == .95 &
                        n_excels == 2) %>% 
  pull(spec)

ref_fit_pers <- mv_res_pers[[ref_fit_ind]]
mv_res_pers <- mv_res_pers[-ref_fit_ind]


# FOR TESTING ONLY
short_mv_res_pers <- mv_res_pers[1:50]
comp_test <- multiverse.compare(short_mv_res_pers, ref_fit_pers, n_ind = 94)
saveRDS(comp_test, here("Network-Multiverse/data/comp_test_pers.RDS"))



tic()
comp_pers <- multiverse.compare(mv_res_pers, ref_fit_pers, n_ind = 94)
toc() # 1439.33 sec elapsed
saveRDS(comp_pers, here("output/mv_personality/comp_pers.RDS"))
comp_pers <- readRDS(here("output/mv_personality/comp_pers.RDS"))
```



Sanity checks: compare GIMME results to mvgimme
```{r}
g_50_50 <- gimme::gimme(data = here("data/wright_2019/individual_files"),
                                         sep = ",",
                                         header = TRUE,
                                         subgroup = TRUE,
                                         ar = TRUE,
                          groupcutoff = .50, 
                          subcutoff = .50)

g_50_75 <- gimme::gimme(data = here("data/wright_2019/individual_files"),
                                         sep = ",",
                                         header = TRUE,
                                         subgroup = TRUE,
                                         ar = TRUE,
                          groupcutoff = .50, 
                          subcutoff = .75)

g_80_50 <- gimme::gimme(data = here("data/wright_2019/individual_files"),
                                         sep = ",",
                                         header = TRUE,
                                         subgroup = TRUE,
                                         ar = TRUE,
                          groupcutoff = .80, 
                          subcutoff = .50)


# Comparison
g_50_50$fit$sub_membership
g_50_75$fit$sub_membership
g_80_50$fit$sub_membership

ind_50_50 <- multiverse_grid %>% 
  mutate(spec = dplyr::row_number()) %>% 
  filter(group_cuts == .50 &
                        sub_cuts == .50 &
                        rmsea_cuts == .05 &
                        srmr_cuts == .05 &
                        nnfi_cuts == .95 &
                        cfi_cuts == .95 &
                        n_excels == 2) %>% 
    pull(spec)

ind_50_75 <- multiverse_grid %>% 
  mutate(spec = dplyr::row_number()) %>% 
  filter(group_cuts == .50 &
                        sub_cuts == .75 &
                        rmsea_cuts == .05 &
                        srmr_cuts == .05 &
                        nnfi_cuts == .95 &
                        cfi_cuts == .95 &
                        n_excels == 2) %>% 
    pull(spec)

ind_80_50 <- multiverse_grid %>% 
  mutate(spec = dplyr::row_number()) %>% 
  filter(group_cuts == .80 &
                        sub_cuts == .50 &
                        rmsea_cuts == .05 &
                        srmr_cuts == .05 &
                        nnfi_cuts == .95 &
                        cfi_cuts == .95 &
                        n_excels == 2) %>% 
    pull(spec)


# compare results individually
mv_50_50 <- mv_res_pers[[ind_50_50]]
mv_50_75 <- mv_res_pers[[ind_50_75]]
mv_80_50 <- mv_res_pers[[ind_80_50]]

# compare loglikelihood
mv_50_50$fit$logl - g_50_50$fit$logl
mv_50_75$fit$logl - g_50_75$fit$logl
mv_80_50$fit$logl - g_80_50$fit$logl

# Copmpare path counts
mv_50_50$path_counts - g_50_50$path_counts
mv_50_75$path_counts - g_50_75$path_counts
mv_80_50$path_counts - g_80_50$path_counts


```




### Summary statistics
#### Group-Level
Nonconvergence:
```{r}
summary(sapply(mv_res_pers, function(y){
  sum(unlist(lapply(y$path_est_mats, function(x) is.logical(x))))
}))


```


Number of group-level edges:
```{r}
# subtract the 6 AR paths
n_group_paths <- sapply(comp_pers$adjacency_g, function(x) sum(unlist(x))) - 6
summary(n_group_paths)
prop.table(table(n_group_paths))
```
Which group-level paths were found most often?
```{r}
Reduce('+', comp_pers$adjacency_g)
```

Heterogeneity of the solution
```{r}
summary(unlist(comp_pers$heterogeneity_g))
```



#### Subgroup-Level
Number and size of subgruops
```{r}
summary(unlist(comp_pers$n_sub_g))
table(unlist(comp_pers$size_sub_s))
```


#### Individual-Level
Adjacency matrix differences, summed across all individuals within a specification.
TODO account for absolute differences. 
```{r}
comp_pers$sum_adj_diff <- lapply(comp_pers$l_diff_adj_i, function(x) sum(Reduce('+', x)))
sd(abs(unlist(comp_pers$sum_adj_diff)))/94 
  

# Check if there are individuals for whom there was a greater difference
# Custom function to add matrices element-wise
add_matrices <- function(matrix_list) {
  reduce_matrix <- matrix(0, nrow = nrow(matrix_list[[1]]), ncol = ncol(matrix_list[[1]]))
  for (matrix in matrix_list) {
    reduce_matrix <- reduce_matrix + matrix
  }
  reduce_matrix
}

# Use lapply to apply the custom function to each matrix name across all elements
result <- lapply(names(comp_pers$l_diff_adj_i[[1]]), function(matrix_name) {
  add_matrices(lapply(comp_pers$l_diff_adj_i, function(element) element[[matrix_name]]))
})

# calculate average difference
avg_diff_adj <- sapply(result, function(x) sum(abs(x)))/3887
summary(avg_diff_adj)
sum(avg_diff_adj > 5)

```


Edge weight differences
```{r}
hist(comp_pers$mean_nonzero_diff_edge_i)
mean(comp_pers$mean_nonzero_diff_edge_i, na.rm = TRUE)
sd(comp_pers$mean_nonzero_diff_edge_i, na.rm = TRUE)
mean(comp_pers$mean_diff_edge_i)
sd(comp_pers$mean_diff_edge_i)


```



Identical centrality estimates
```{r}
summary(comp_pers$sum_temp_central_identical_i)
summary(comp_pers$sum_cont_central_identical_i)

# Again, calculate individual differences
l_temp_ident <- list()
l_cont_ident <- list()
for(i in 1:comp_pers$n_ind[[1]]){
  l_temp_ident[[i]] <- lapply(comp_pers$central_node_identical_i, function(x){
    x[[i]]$temp_identical
  })
  l_cont_ident[[i]] <- lapply(comp_pers$central_node_identical_i, function(x){
    x[[i]]$cont_identical
  })
}

# How often are they identical?
most_cent_ident_temp <- sapply(l_temp_ident, function(x){sum(unlist(x))})
sum(most_cent_ident_temp >= 3887)

most_cent_ident_cont <- sapply(l_cont_ident, function(x){sum(unlist(x))})
sum(most_cent_ident_cont >= 3887)

# identical for both
sum(most_cent_ident_temp >= 3887 & most_cent_ident_cont >= 3887)

# identical less than one third
sum(most_cent_ident_temp <= 3887/3)
sum(most_cent_ident_cont <= 3887/3)


```


Fit indices
```{r}
fit_ind_diff <- do.call(rbind, comp_pers$mean_diff_fit_i)
mean_fit_ind_diff <- colMeans(fit_ind_diff)
summary(fit_ind_diff)
```




## Emotion Dataset
Delete reference fit from multiverse dataset.
TODO it was .51, not .75, so maybe compare to original dataset?
```{r}
ref_fit_ind <- multiverse_grid %>% 
  mutate(spec = dplyr::row_number()) %>% 
  filter(group_cuts == .75 &
                        sub_cuts == .50 &
                        rmsea_cuts == .05 &
                        srmr_cuts == .05 &
                        nnfi_cuts == .95 &
                        cfi_cuts == .95 &
                        n_excels == 2) %>% 
  pull(spec)

ref_fit_emot <- mv_res_emot[[ref_fit_ind]]
mv_res_emot <- mv_res_emot[-ref_fit_ind]

# Analyze
tic()
comp_emot <- multiverse.compare(mv_res_emot, ref_fit_emot_og, n_ind = 105)
toc()  # 2040.35 sec elapsed
beepr::beep(6)
saveRDS(comp_emot, here("output/mv_emotion/comp_emot.RDS"))

```


Sanity check comparison: 
```{r}
g_75_51_emot <- mvgimme::multiverse.gimme(data = here("data/kullar_2023/finaloutput"),
                                         header = TRUE,
                                         sep = ",",
                                         subgroup = TRUE,
                                         ar = TRUE,
                                         groupcutoffs = .75,
                                         subcutoffs = .51,
                                         rmsea.cuts = .05,
                                         srmr.cuts = .05,
                                         nnfi.cuts = .95,
                                         cfi.cuts = .95,
                                         n.excellent = 2,
                                         prune_output = TRUE,
                                         exogenous = "TimeofDay")
saveRDS(g_75_51_emot, here("output/mv_emotion/g_75_51_emot.RDS"))

# check subgrouping
g_75_51_emot[[1]]$path_counts - ref_fit_emot_og$path_counts

# This 1 % difference changes a lot
subcheck <- Map('-', ref_fit_emot$path_counts_sub, ref_fit_emot_og$path_counts_sub)
sum(abs(unlist(subcheck)))


```




### Summary statistics
#### Group-Level
Nonconvergence:
```{r}
table(sapply(mv_res_emot, function(y){
  sum(unlist(lapply(y$path_est_mats, function(x) is.logical(x))))
}))


```


Number of group-level edges:
```{r}
# subtract the AR paths
n_group_paths <- sapply(comp_emot$adjacency_g, function(x) sum(unlist(x)))
summary(n_group_paths)
prop.table(table(n_group_paths))
```
Which group-level paths were found most often?
```{r}
Reduce('+', comp_emot$adjacency_g)
```

Heterogeneity of the solution
```{r}
summary(unlist(comp_emot$heterogeneity_g))
```



#### Subgroup-Level
Number and size of subgruops
```{r}
# summary(unlist(comp_emot$n_sub_g)) # there is an error here for now
# TODO change back after recomputing
table(unlist(lapply(mv_res_emot, function(x){
  length(unique(x$fit$sub_membership))
})))

table(unlist(comp_emot$size_sub_s))

# Check number of distinct solutions
length(unique(lapply(comp_emot$size_sub_s, function(x){
  as.character(x)
})))

# Which are these?
unique(lapply(comp_emot$size_sub_s, function(x){
  as.character(x)
}))

```
subgroup membership



ARI and VI
```{r}
table(comp_emot$vi)
table(comp_emot$ari)

# When is ARI low?
comp_emot %>% 
  filter(ari != 1) %>% 
  count(groupcutoffs, subcutoffs)

```





#### Individual-Level
Adjacency matrix differences, summed across all individuals within a specification.
TODO account for absolute differences. 
```{r}
comp_emot$sum_adj_diff <- lapply(comp_emot$l_diff_adj_i, function(x) sum(Reduce('+', x)))
sd(abs(unlist(comp_emot$sum_adj_diff)))/105
  

# Check if there are individuals for whom there was a greater difference
# Custom function to add matrices element-wise
add_matrices <- function(matrix_list) {
  reduce_matrix <- matrix(0, nrow = nrow(matrix_list[[1]]), ncol = ncol(matrix_list[[1]]))
  for (matrix in matrix_list) {
    reduce_matrix <- reduce_matrix + matrix
  }
  reduce_matrix
}

# Use lapply to apply the custom function to each matrix name across all elements
result <- lapply(names(comp_emot$l_diff_adj_i[[1]]), function(matrix_name) {
  add_matrices(lapply(comp_emot$l_diff_adj_i, function(element) element[[matrix_name]]))
})

# calculate average difference
avg_diff_adj <- sapply(result, function(x) sum(abs(x)))/3887
summary(avg_diff_adj)
sum(avg_diff_adj > 5)

```


Edge weight differences
```{r}
hist(comp_emot$mean_nonzero_diff_edge_i)
mean(comp_emot$mean_nonzero_diff_edge_i, na.rm = TRUE)
sd(comp_emot$mean_nonzero_diff_edge_i, na.rm = TRUE)
mean(comp_emot$mean_diff_edge_i)
sd(comp_emot$mean_diff_edge_i)


```



Identical centrality estimates
```{r}
summary(comp_emot$sum_temp_central_identical_i)
summary(comp_emot$sum_cont_central_identical_i)

# Again, calculate individual differences
l_temp_ident <- list()
l_cont_ident <- list()
for(i in 1:comp_emot$n_ind[[1]]){
  l_temp_ident[[i]] <- lapply(comp_emot$central_node_identical_i, function(x){
    x[[i]]$temp_identical
  })
  l_cont_ident[[i]] <- lapply(comp_emot$central_node_identical_i, function(x){
    x[[i]]$cont_identical
  })
}

# How often are they identical?
most_cent_ident_temp <- sapply(l_temp_ident, function(x){sum(unlist(x))})
sum(most_cent_ident_temp >= 3887)

most_cent_ident_cont <- sapply(l_cont_ident, function(x){sum(unlist(x))})
sum(most_cent_ident_cont >= 3887)

# identical for both
sum(most_cent_ident_temp >= 3887 & most_cent_ident_cont >= 3887)

# identical less than one third
sum(most_cent_ident_temp <= 3887/3)
sum(most_cent_ident_cont <= 3887/3)


```


Fit indices
```{r}
fit_ind_diff <- do.call(rbind, comp_emot$mean_diff_fit_i)
mean_fit_ind_diff <- colMeans(fit_ind_diff)
summary(fit_ind_diff)
```














# Visualize Multiverse
Preparation: 
```{r}
# Color palette
palette_3 <- colorRampPalette(brewer.pal(9, "RdBu"))(3)
palette_4 <- colorRampPalette(brewer.pal(9, "RdBu"))(4)

# TODO change blue color values

# Set values explicitly 
palette_full <- c(palette_4[1:2], "lightblue", palette_4[3:4])
names(palette_full) <- c("liberal", "medium-liberal", "medium", "medium-strict", "strict")

# Define the desired levels for each factor
group_levels <- c("liberal", "medium-liberal", "medium-strict", "strict")
sub_levels <- c("liberal", "medium-liberal", "medium-strict", "strict")
rmsea_levels <- c("strict", "medium", "liberal")
srmr_levels <- c("strict", "medium", "liberal")
nnfi_levels <- c("liberal", "medium", "strict")
cfi_levels <- c("liberal", "medium", "strict")
n_excels_levels <- c("strict", "medium", "liberal")


```

## Personality Dataset


### Manuscript

Specification curve plot adjacency matrix
```{r}
plot_out_adj_pers <- plot_outcome(mv_res = comp_pers, var = sum_adj_diff,
                                  y_label = "Sum of Adjacency Matrix Differences") +
  theme(axis.title = element_text(size = rel(1.5)),
        axis.text = element_text(size = rel(1.5)))
plot_spec_adj_pers <- plot_specification(mv_res = comp_pers, var = sum_adj_diff)+
  theme(axis.title = element_text(size = rel(1.5)),
        axis.text = element_text(size = rel(1.5)))

# Combine Plots
spec_plot_adj_pers <- cowplot::plot_grid(plot_out_adj_pers, plot_spec_adj_pers, 
                   nrow = 2, align = "h",
                   rel_heights = c(0.5,1))
ggsave("spec_plot_adj_pers.pdf", spec_plot_adj_pers, path = here("figures/"),
       device = "pdf", height = 16, width = 16)

```




Network multiverse plot
```{r}
# TODO add better legend/node labels here
pdf(here("figures/mv_net_pers.pdf"), width = 8, height = 4)
multiverse.network(comp_pers, cutoff = .05, title.cex = 1, label.cex = 1.2, n_ind = 94)
dev.off()

```


Specification curve plot density
```{r}
plot_out_dens_pers <- plot_outcome(mv_res = comp_pers, 
                              var = mean_diff_dens_cont_i,
                              y_label = "Density Difference") +
  theme(axis.title = element_text(size = rel(1.5)),
        axis.text = element_text(size = rel(1.5)))
plot_spec_dens_pers <- plot_specification(mv_res = comp_pers, var = mean_diff_dens_cont_i)+
  theme(axis.title = element_text(size = rel(1.5)),
        axis.text = element_text(size = rel(1.5)))

# Combine Plots
spec_plot_dens_pers <- cowplot::plot_grid(plot_out_dens_pers, plot_spec_dens_pers, 
                   nrow = 2, align = "h",
                   rel_heights = c(0.5,1))
ggsave("spec_plot_abs_dens_pers.pdf", spec_plot_dens_pers, path = here("figures/"),
       device = "pdf", height = 16, width = 16)

```



### Supplement


## Emotion Dataset

Specification curve plot adjacency matrix
```{r}
plot_out_adj_emot <- plot_outcome(mv_res = comp_emot, var = sum_adj_diff,
                                  y_label = "Sum of Adjacency Matrix Differences") +
  theme(axis.title = element_text(size = rel(1.5)),
        axis.text = element_text(size = rel(1.5)))
plot_spec_adj_emot <- plot_specification(mv_res = comp_emot, var = sum_adj_diff)+
  theme(axis.title = element_text(size = rel(1.5)),
        axis.text = element_text(size = rel(1.5)))

# Combine Plots
spec_plot_adj_emot <- cowplot::plot_grid(plot_out_adj_emot, plot_spec_adj_emot, 
                   nrow = 2, align = "h",
                   rel_heights = c(0.5,1))
ggsave("spec_plot_adj_emot.pdf", spec_plot_adj_emot, path = here("figures/"),
       device = "pdf", height = 16, width = 16)

```


Network multiverse plot
```{r}
# TODO add better legend/node labels here
pdf(here("figures/mv_net_emot.pdf"), width = 8, height = 4)
multiverse.network(comp_emot, cutoff = .05, 
                   title.cex = 1, label.cex = 1.2, 
                   n_ind = 105)
dev.off()

```


Specification curve plot density
```{r}
plot_out_dens_emot <- plot_outcome(mv_res = comp_emot, 
                              var = mean_diff_dens_cont_i,
                              y_label = "Density Difference") +
  theme(axis.title = element_text(size = rel(1.5)),
        axis.text = element_text(size = rel(1.5)))
plot_spec_dens_emot <- plot_specification(mv_res = comp_emot, var = mean_diff_dens_cont_i)+
  theme(axis.title = element_text(size = rel(1.5)),
        axis.text = element_text(size = rel(1.5)))

# Combine Plots
spec_plot_dens_emot <- cowplot::plot_grid(plot_out_dens_emot, plot_spec_dens_emot, 
                   nrow = 2, align = "h",
                   rel_heights = c(0.5,1))
ggsave("spec_plot_abs_dens_emot.pdf", spec_plot_dens_emot, path = here("figures/"),
       device = "pdf", height = 16, width = 16)

rm(plot_out_dens_emot)
rm(plot_spec_dens_emot)
rm(spec_plot_dens_emot)
```



### Manuscript


### Supplement